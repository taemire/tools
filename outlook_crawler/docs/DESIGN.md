# Outlook Web Crawler 설계 문서

## 개요
Microsoft Outlook Web(outlook.office.com)에서 메일 데이터를 수집하는 Playwright 기반 크롤러.

---

## 핵심 설계: 수동 인증 대기 플로우

### 문제점
- Microsoft 계정은 대부분 **2FA(MFA)** 가 활성화되어 있음
- OTP 앱 승인, SMS 코드, 보안키 등 **사람의 개입**이 필수
- 완전 자동화 로그인은 보안 정책상 불가능한 경우가 많음

### 해결책: Semi-Automated Flow
```
┌─────────────────────────────────────────────────────────────┐
│  1. 브라우저 실행 (headless: false)                         │
│     └─ 사용자가 화면을 볼 수 있도록 실제 브라우저 창 열림    │
├─────────────────────────────────────────────────────────────┤
│  2. 자동 로그인 시도                                        │
│     ├─ 이메일 입력 → 자동                                   │
│     ├─ 패스워드 입력 → 자동                                 │
│     └─ [MFA 화면 감지] → 수동 대기 모드 진입                 │
├─────────────────────────────────────────────────────────────┤
│  3. 🖐️ 수동 인증 대기                                       │
│     ├─ 콘솔에 안내 메시지 출력                              │
│     │   "브라우저에서 2단계 인증을 완료해주세요..."          │
│     └─ 메일함 로딩 완료까지 무한 대기 (timeout: 5분)        │
├─────────────────────────────────────────────────────────────┤
│  4. 메일함 진입 확인                                        │
│     └─ 'Message list' 요소 감지 시 다음 단계로 진행         │
├─────────────────────────────────────────────────────────────┤
│  5. 데이터 수집 (자동)                                      │
│     ├─ 메일 목록 스크래핑                                   │
│     ├─ 필요시 스크롤 다운하며 추가 수집                     │
│     └─ JSON/CSV 파일로 저장                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 구현 상세

### 1. 환경 설정
```bash
# .env 파일
OUTLOOK_EMAIL=user@company.com
OUTLOOK_PASSWORD=secret
AUTH_TIMEOUT_MS=300000  # 5분 (MFA 대기 시간)
```

### 2. MFA 감지 로직
MFA 화면은 다양한 형태로 나타남. 공통적으로 **메일함이 아직 안 떴다**는 것으로 판단:
- `div[aria-label="Message list"]` 또는 `div[role="listbox"]` 부재
- URL이 여전히 `login.microsoftonline.com` 인 경우

### 3. 대기 중 사용자 안내 (콘솔)
```
╔══════════════════════════════════════════════════════════╗
║  🔐 2단계 인증이 필요합니다.                              ║
║                                                          ║
║  열린 브라우저 창에서 인증을 완료해주세요.               ║
║  (OTP 입력, 앱 승인, SMS 코드 등)                        ║
║                                                          ║
║  인증 완료 후 메일함이 로딩되면 자동으로 진행됩니다.     ║
║  대기 시간: 최대 5분                                     ║
╚══════════════════════════════════════════════════════════╝
```

### 4. 세션 재사용 (고급 기능)
매번 로그인하지 않도록 **쿠키/로컬스토리지 저장** 기능 추가 가능:
```javascript
// 세션 저장
await context.storageState({ path: 'session.json' });

// 다음 실행 시 세션 복원
const context = await browser.newContext({ storageState: 'session.json' });
```

---

## 파일 구조
```
tools/outlook_crawler/
├── package.json
├── .env              # 계정 정보 (git ignore 필수)
├── index.js          # 메인 스크립트
├── session.json      # 저장된 세션 (선택)
├── output/
│   ├── emails.json   # 수집된 메일 데이터
│   └── inbox.png     # 스크린샷
└── docs/
    └── DESIGN.md     # 본 문서
```

---

## 실행 방법
```bash
cd tools/outlook_crawler
npm install
npm start
```

---

## 보안 주의사항

> [!CAUTION]
> - `.env` 파일은 절대 Git에 커밋하지 마세요 (`.gitignore` 추가 필수)
> - `session.json`에는 로그인 세션이 저장되므로 안전하게 관리하세요
> - 이 도구는 개인/업무 목적으로만 사용하고, 타인의 계정에 무단 접근하지 마세요
